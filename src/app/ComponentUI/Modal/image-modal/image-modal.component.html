<button mat-icon-button class="close-button" [mat-dialog-close]="true">
  <mat-icon class="close-icon" color="warn">close</mat-icon>
</button>


<div class="modal-container">
  <div class="modal-left">
    <mat-progress-bar *ngIf="isLoading" mode="indeterminate" color="primary"></mat-progress-bar>

    <div id="carouselExample" class="carousel slide" data-bs-ride="carousel" data-bs-interval="4000">
      <div class="carousel-inner">
        <div class="carousel-item" *ngFor="let post of posts; let i = index" [class.active]="i === currentIndex">
          <ng-container *ngIf="post.posts_type === 'image'">
            <img [src]="post.path_url" class="d-block w-100 media-item" alt="Preview Image" />
          </ng-container>

          <ng-container *ngIf="post.posts_type === 'video'">
            <video class="d-block w-100 media-item" controls preload="metadata">
              <source [src]="post.path_url" type="video/mp4" />
              Your browser does not support the video tag.
            </video>
          </ng-container>
        </div>
      </div>

      <button *ngIf="posts.length > 1" class="carousel-control-prev" type="button" data-bs-target="#carouselExample"
        data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      </button>

      <button *ngIf="posts.length > 1" class="carousel-control-next" type="button" data-bs-target="#carouselExample"
        data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
      </button>
    </div>
  </div>

  <!-- RIGHT SIDE: Reactions & Comments -->
  <div class="modal-right">
    <!-- Reactions Summary -->
    <div class="reactions-summary">
      <ng-container *ngFor="let reaction of displayedReactions">
        <span class="emoji" [ngStyle]="{ 'z-index': 10 - reaction.index, 'left.px': reaction.index * 12 }">
          {{ reactionEmojiMap[reaction.name] }}
        </span>
      </ng-container>
      <a *ngIf="totalReactionsCount > 0" (click)="openReactionsModal()"
        style="cursor: pointer; color: blue; text-decoration: underline;">
        You and {{ totalReactionsCount - 1 }} others
      </a>

    </div>

    <!-- Buttons -->
    <mat-card-actions class="interaction-buttons">
      <div class="like-button-wrapper" (mouseenter)="showReactions = true" (mouseenter)="showReactions = true">
        <button mat-button color="primary">
          <mat-icon *ngIf="!hoveredReaction">{{ selectedReaction?.emoji || 'thumb_up' }}</mat-icon>
          <mat-icon *ngIf="hoveredReaction">{{ hoveredReaction.emoji }}</mat-icon>
        </button>

        <div class="reactions-popup" *ngIf="showReactions">
          <div class="reaction" *ngFor="let react of reactions" (mouseenter)="hoveredReaction = react"
            (click)="selectReaction(react)">
            <span>{{ react.emoji }}</span>
          </div>
        </div>
      </div>

      <button mat-button color="primary">
        <mat-icon>repeat</mat-icon> Repost
      </button>
      <button mat-button color="primary">
        <mat-icon>repeat</mat-icon> Share
      </button>
      <button mat-button color="primary">
        <mat-icon>send</mat-icon> Send
      </button>
    </mat-card-actions>


    <!-- Comments -->
    <div class="comments-container">
      <div *ngFor="let comment of comments" class="comment">
        <img [src]="comment.profile_pic || 'assets/images/default.png'" alt="User" class="comment-avatar">

        <div class="comment-content">
          <strong>{{ comment.fullname }}</strong>

          <!-- edit comment by usercode -->
          <button *ngIf="currentUserCode == comment.code" mat-icon-button class="action-button" color="primary"
            (click)="editComment(comment)">
            <mat-icon>edit</mat-icon>
          </button>

          <p>{{ comment.comment }} </p>
          <small>{{ comment.date_comment }}</small>

          <div class="comment-actions" *ngIf="comment">
            <button mat-button (click)="likeComment(comment)">Like</button>
            <span>{{ comment.likes || 0 }} Like{{ comment.likes === 1 ? '' : 's' }}</span>
            <button mat-button (click)="comment.showReply = !comment.showReply">Reply</button>
          </div>

          <!--public edit comment by usercode -->
          <div *ngIf="comment.isEditing">
            <mat-form-field class="form-field" appearance="outline">
              <mat-label>Write edit comment...</mat-label>
              <input matInput [(ngModel)]="comment.comment"
                (keyup.enter)="editHeadersComment(comment, comment.comment_uuid)">
            </mat-form-field>
            <button mat-icon-button color="primary" (click)="editHeadersComment(comment, comment.comment_uuid)">
              <mat-icon>check</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="cancelReplyEdit(comment)">
              <mat-icon>close</mat-icon>
            </button>
          </div>

          <!-- Reply Input -->
          <div *ngIf="comment.showReply">
            <mat-form-field class="form-field" appearance="outline">
              <mat-label>Write reply comment...</mat-label>
              <input matInput placeholder="Write a reply..." [(ngModel)]="comment.newReply"
                (keyup.enter)="addReply(comment)" />

            </mat-form-field>
            <button mat-icon-button color="primary" (click)="addReply(comment)">
              <mat-icon>send</mat-icon>
            </button>
          </div>

          <!-- Replies -->
          <div class="replies" *ngIf="comment.replies?.length">
            <div *ngFor="let reply of comment.replies" class="reply">
              <img [src]="reply.profile_pic || 'assets/images/default.png'" alt="User" class="comment-avatar" />
              <div class="reply-body">
                <strong>{{ reply.fullname }}</strong>
                <p>{{ reply.comment }}</p>
                <small>{{ reply.date_comment }}</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <mat-dialog-actions align="end">
      <mat-progress-bar *ngIf="isSubmitting" mode="indeterminate" color="primary"></mat-progress-bar>

      <mat-form-field appearance="outline" class="form-field">
        <mat-label>Write a comment...</mat-label>
        <input matInput [(ngModel)]="newComment" (keyup.enter)="addComment()" placeholder="Write a public comment..."
          aria-label="Comment" />
        <button mat-icon-button matSuffix color="primary" (click)="addComment()" aria-label="Send">
          <mat-icon>send</mat-icon>
        </button>
      </mat-form-field>
    </mat-dialog-actions>

  </div>
</div>